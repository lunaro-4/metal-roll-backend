# О проекте
Это репозиторий проекта, разрабатываемого в качестве тестового задания для стажерской програмы "Северстали" по направлению "разработка и программирование”.

Суть проекта - создание backend для работы со складом рулонов металла.



# Установка

## Веб-сервис

Для хостинга веб-сервиса необходимо склонировать репозиторий и скачать зависимости

```
git clone https://github.com/lunaro-4/metal-roll-backend.git
cd metal-roll-backend
python -m venv venv 
venv/bin/bash build.sh
```
Вариант без создания виртуальной среды:
```
git clone https://github.com/lunaro-4/metal-roll-backend.git
cd metal-roll-backend
./build.sh
```
Обращаю внимание, что при такой установке настоятельно рекомендуется создать файл `.env` с переменными среды в корне проекта.
О его наполнении можно узнать в пункте [настройка](#Настройка).

После этого запускаем FastAPI с помощью uvicorn

Если установка проводилась с созданием виртуальной среды:

```
venv/bin/python -m uvicorn app:init_app
```

Если виртуальная среда не создавалась:

```
python -m uvicorn app:init_app
```

По умолчанию, сервис доступен по адресу ``127.0.0.1:8000``

## Веб-сервис внутри docker

Для запуска проекта внутри контейнера, необходимо клонировать репозиторий и построить контейнер:

```
git clone https://github.com/lunaro-4/metal-roll-backend.git
cd metal-roll-backend
sudo docker build --tag metal-roll-backend .
```

По завершении создания образа, запускаем контейнер

```
sudo docker run -p 8000:8000 --rm --name metal-roll-backend metal-roll-backend

```

Очень важно указать параметр  ``-p <ваш_порт>:8000``, чтобы вы могли подключится к сервису в вашем браузере

После этого сервис будет доступен в браузере по адресу ``127.0.0.1:<ваш_порт>``



# Использование

## Настройка

По умолчанию база данных sqlite3 находится в корне проекта `*/metal-roll-backend/sql_app.db`. Это можно поменять, создав файл .env

В файле .env описаны следующие переменные:

 - `DATABASE_PATH` :  указывает на расположение базы данных, относительно корня проекта.
 - `DATE_FORMAT` : описывает формат даты в запросах, согласно [документации time.srtptime](https://docs.python.org/3/library/time.html#time.strptime)
 
Образец заполнения и значения по умолчанию написаны в файле [config_env](config_env)

## Запросы


Далее будет использовать адрес сервиса как корень, то есть если вы указали 127.0.0.1 в качестве адреса сервера, адрес `/coil` будет отсылать к `127.0.0.1/coil`
Запросы можно опробовать по адресу `/docs`, стандартному для FastAPI.

Всего поддерживается 4 запроса:

### GET /coil

Возвращает массив всех записанных рулонов.
Поддерживает фильтрацию с помощью парных переменных запроса, отвечающих за начало и конец промежутка, включая крайние точки:

 - `id_start` & `id_end` : фильтрация по id рулона в базе данных 
 - `length_start` & `lengh_end`: фильтрация по длине рулона
 - `weight_start` & `weight_end`: фильтрация по весу рулона
 - `add_date_start` & `add_date_end`: фильтрация по дате добавления
 - `del_date_start` & `del_date_end`: фильтрация по дате удаления

Параметры фильтрации независимы и их можно комбинировать. Если необходимо получить рулон с конкретным значением параметра, указание значения в _start и _end вернет все рулоны с конкретным значением.

Примеры использования:

`/coil?id_start=20&id_end=20` - Возвращает рулон с id = 20

`/coil?id_start=6&length_start=0.1&length_end=10` - возвращает рулон c id не менее 6, и длинной между 0.1 и 10 




### POST /coil

Добавляет в базу данных новый рулон с указанными длинной и весом. Опционально можно указать дату добавления и дату удаления.
В качестве ответа будет представлена запись из базы данных с добавленным рулоном с присвоенным id

Возможные поля запроса:

 - `length` : длинна рулона
 - `weight` : вес рулона
 - [опционально] `add_date` - дата добавления
 - [опционально] `del_date` - дата удаления

Пример запроса:

``` json
{
  "length": 3,
  "weight": 5,
  "add_date": "2020-10-01",
  "id": 0
}
```
Ответ [id генерируется автоматически]:

``` json
{
  "length": 3,
  "weight": 5,
  "add_date": "2020-10-01",
  "del_date": "None",
  "id": 6
}
```

### DELETE /coil

Удаляет рулон с `id`, указанном в параметре `coil_id`. Возвращает либо данные об удаленном рулоне, либо ошибку, если рулон не найден.


### GET /coil/stats

Выдает статистику по рулонам:

 - `roll_add_amount` : Количество добавленых рулонов
 - `roll_del_amount` : Количество удаленных рулонов
 - `avg_len` : Средняя длинна рулона
 - `max_len` : Максимальная длинна рулона
 - `min_len` : Минимальная длинна рулона
 - `avg_weight` : Средний вес рулона
 - `max_weight` : Максимальный вес рулона
 - `min_weight` : Минимальный вес рулона
 - `sum_weight_in_range` : Сумма весов рулонов, находившихся на складе
 - `max_add_del_gap` : Максимальный промежуток между добавлением и удалением рулона
 - `min_add_del_gap` : Минимальный промежуток между добавлением и удалением рулона
 - `max_weight_date` : День, когда на складе был зафиксирован максимальный суммарный вес рулонов 
 - `min_weight_date` : День, когда на складе был зафиксирован минимальный суммарный вес рулонов

Переменные запроса start_date и end_date ограничивают выборку рулонов для статистики. Поддерживается подача как одной переменной, так и обеих.


# Мои контакты

Если вам понравилось или не понравилось мое исполнение, не стесняйтесь сообщить мне об этом!

| Тип контакта | Контактная информация |
| ------------- | -------------- |
| e-mail | pavelike@gmail.com |
| telegram | @lunaro_4 |
| телефон | +7-911-094-00-28 |
| mastodon | @lunaro_4@techhub.social |



